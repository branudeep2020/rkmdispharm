<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile</title>
    <style>
        body{
        margin-top:20px;
        background:#f8f8f8
    }
    .imgcss{
      height: 140px; width :140px; background-color: rgb(233, 236, 239);
    }
      
    </style>
    <link href="/js/bootstrap4/bootstrap-4.5.0.min.css" rel="stylesheet" />
    <link href="/js/bootstrap4/font-awesome.min-4.3.0.css" rel="stylesheet" />
    <link href="/css/toastr.min.css" rel="stylesheet" />
    <script src="/js/bootstrap4/js/jquery-3.5.1.min.js"></script>
    <script src="/js/bootstrap4/js/popper-1.16.0.min.js"></script>
    <script src="/js/bootstrap4/js/bootstrap-4.5.0.min.js"></script>
    <script src="/js/toastr.min.js"></script>
    <script src="/js/jquery.form.min.js"></script>
    <script>
      toastr.options = {
        "closeButton": true,
        "debug": false,
        "newestOnTop": false,
        "progressBar": false,
        "positionClass": "toast-top-right",
        "preventDuplicates": false,
        "onclick": null,
        "showDuration": "300",
        "hideDuration": "1000",
        "timeOut": "5000",
        "extendedTimeOut": "1000",
        "showEasing": "swing",
        "hideEasing": "linear",
        "showMethod": "fadeIn",
        "hideMethod": "fadeOut"
      }
    </script>

</head>
<body>
    

<div class="container" style="width: 600px;">
<div class="row flex-lg-nowrap">
  <div class="col">
    <div class="row">
      <div class="col mb-3">
        <div class="card">
          <div class="card-body">
            <div class="e-profile">
              <div class="row">
                <div class="col-12 col-sm-auto mb-3">
                  <div class="mx-auto" style="width: 140px;">
                    <div id="prfimg" class="d-flex justify-content-center align-items-center rounded imgcss">
                      <!-- <span id="prfimg" style="color: rgb(166, 168, 170); font: bold 8pt Arial;">140x140</span> -->
                      <img id="imgtag" src="" alt="Profile Pictute" height="140px" width="140px">
                    </div>
                  </div>
                </div>
                <div class="col d-flex flex-column flex-sm-row justify-content-between mb-3">
                  <div class="text-center text-sm-left mb-2 mb-sm-0">
                    <h4 class="pt-sm-2 pb-1 mb-0 text-nowrap" id="name">name</h4>
                    <p class="mb-0" id="username">username</p>
                    <span class="badge badge-secondary" id="usertype">user type</span>
                    <!-- <div class="text-muted"><small>Last seen 2 hours ago</small></div> -->
                    <div class="mt-2">
                      <button class="btn btn-primary" type="button" data-toggle="modal" data-target="#uploadModal">
                        <i class="fa fa-fw fa-camera"></i>
                        <span>Change Photo</span>
                      </button>
                    </div>
                  </div>
                  <!-- <div class="text-center text-sm-right">
                    <span class="badge badge-secondary">user type</span>
                     <div class="text-muted"><small>Joined 09 Dec 2017</small></div>
                  </div> -->
                </div>
              </div>
              <!-- <ul class="nav nav-tabs">
                <li class="nav-item"><a href="" class="active nav-link">Settings</a></li>
              </ul> -->
              <div class="tab-content pt-3">
                <div class="tab-pane active">
                  <form class="form" novalidate="">
                    <div class="row">
                      <div class="col">
                        <div class="row">
                          <div class="col">
                            <div class="form-group">
                              <label>Full Name</label>
                              <input class="form-control" id="frmname" type="text" name="name" placeholder="John Smith" value="John Smith">
                            </div>
                          </div>
                          <div class="col">
                            <div class="form-group">
                              <label>Username</label>
                              <input class="form-control" id="frmusername" type="text" name="username" placeholder="johnny.s" value="johnny.s">
                            </div>
                          </div>
                        </div>
                        <div class="row">
                          <div class="col">
                            <div class="form-group">
                              <label>Email</label>
                              <input class="form-control" id="frmemail" type="text" placeholder="user@example.com">
                            </div>
                          </div>
                        </div>
                        <!-- <div class="row">
                          <div class="col mb-3">
                            <div class="form-group">
                              <label>About</label>
                              <textarea class="form-control" rows="5" placeholder="My Bio"></textarea>
                            </div>
                          </div>
                        </div> -->
                      </div>
                    </div>
                    <label></label><input type="checkbox" id="up" name="up" value="up"> Update password ?</label>
                    <div class="row" id="upDiv">
                      <div class="col-12 col-sm-6 mb-3">
                        <div class="mb-2"><b>Change Password</b></div>
                        <div class="row">
                          <div class="col">
                            <div class="form-group">
                              <label>Current Password</label>
                              <input class="form-control" id="currpass" type="password" placeholder="••••••">
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="col-12 col-sm-5 offset-sm-1 mb-3">
                        <div class="mb-2"><b>&emsp;</b></div>
                        <div class="row">
                            <div class="col">
                              <div class="form-group">
                                <label>New Password</label>
                                <input class="form-control" id="newpass" type="password" placeholder="••••••">
                              </div>
                            </div>
                          </div>
                          <div class="row">
                            <div class="col">
                              <div class="form-group">
                                <label>Confirm <span class="d-none d-xl-inline">Password</span></label>
                                <input class="form-control" id="newpassconfirm" type="password" placeholder="••••••"></div>
                            </div>
                          </div>
                      </div>
                      <!-- <div class="col-12 col-sm-5 offset-sm-1 mb-3">
                        <div class="mb-2"><b>Keeping in Touch</b></div>
                        <div class="row">
                          <div class="col">
                            <label>Email Notifications</label>
                            <div class="custom-controls-stacked px-2">
                              <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input" id="notifications-blog" checked="">
                                <label class="custom-control-label" for="notifications-blog">Blog posts</label>
                              </div>
                              <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input" id="notifications-news" checked="">
                                <label class="custom-control-label" for="notifications-news">Newsletter</label>
                              </div>
                              <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input" id="notifications-offers" checked="">
                                <label class="custom-control-label" for="notifications-offers">Personal Offers</label>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div> -->
                    </div>
                    <div class="row">
                      <div class="col d-flex justify-content-end">
                        <!-- <button class="btn btn-light" type="submit">Back</button> -->
                        <a href="/dashboard" class="btn btn-light">Back</a>
                        <button class="btn btn-primary" id="updateUser" type="button">Save Changes</button>
                      </div>
                    </div>
                  </form>

                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- <div class="col-12 col-md-3 mb-3">
        <div class="card mb-3">
          <div class="card-body">
            <div class="px-xl-3">
              <button class="btn btn-block btn-secondary">
                <i class="fa fa-sign-out"></i>
                <span>Back</span>
              </button>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-body">
            <h6 class="card-title font-weight-bold">Support</h6>
            <p class="card-text">Get fast, free help from our friendly assistants.</p>
            <button type="button" class="btn btn-primary">Contact Us</button>
          </div>
        </div>
      </div> -->


    </div>

  </div>
</div>
</div>


  <!-- Modal -->
<div id="uploadModal" class="modal fade" role="dialog">
  <div class="modal-dialog modal-sm">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <span class="modal-title"><b>Profile Picture</b></span>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body">
          <img id="preview" src="/img/profile/prf.png" class="img-thumbnail" alt="your image" style="border: 1px solid black; height: 200px; width: 200px; margin-left: 30px;" />
        <!-- Form style=" style='margin: 20px 170px;'"-->
        <form enctype="multipart/form-data" id="uploadForm" action="/users/uploadimage" method="POST">
           <!-- <input type='file' name='file' id='file' class='form-control' ><br> -->
           <span style="margin: 5px 85px">Select file</span>
          <input type='file' onchange="readURL(this);" name='myImage' id='myImage' style="margin: 10px 70px"/> <br>
            
            <input type='submit' class='btn btn-info' value='Upload' id='btn_upload' style="margin-left: 30%">
        </form>
        <!-- Preview  style="padding: 40px;"-->
        <!-- <div id='preview'></div> -->
      </div>
 
    </div>

  </div>
</div>


</body>
</html>

<script>
  function readURL(input) {
    //https://stackoverflow.com/questions/12368910/html-display-image-after-selecting-filename
      if (input.files && input.files[0]) {
          var reader = new FileReader();

          reader.onload = function (e) {
              $('#preview')
                  .attr('src', e.target.result)
                  .width(200)
                  .height(200);
          };

          reader.readAsDataURL(input.files[0]);
      }
  }
  $(document).ready(function(){
    var uppass=false;
    $('#upDiv').hide();

      $.ajax({
        type : 'POST',
        url:'/users/usersettings',
        headers: {"x-access-token": localStorage.getItem('token')},
        success : function(response){
          $('#name').html(response.userDetails[0].name);
          $('#username').html(response.userDetails[0].username);
          $('#frmname').val(response.userDetails[0].name);
          $('#frmusername').val(response.userDetails[0].username);
          $('#frmemail').val(response.userDetails[0].email);
          if(response.userDetails[0].usertype == 1 )$('#usertype').html('Admin');
          if(response.userDetails[0].usertype == 2 )$('#usertype').html('Collector');
          var imageUrl = '/img/profile/'+response.userDetails[0].image;
          $("#imgtag").attr("src", imageUrl); 
        },
        error : function(response){
          toastr.error(response.msg);
        }
      });

      $(document).on('click', 'input[type="checkbox"]', function() { 
          $('#upDiv').toggle();
          if($(this).prop("checked") == true){
            //console.log("Checkbox is checked.");
            uppass=true;
          }
          if($(this).prop("checked") == false){
            //console.log("Checkbox is checked.");
            uppass=false;
          }
      });

      $(document).on('click', '#updateUser', function() { 
        var passpram;
        var name = $('#frmname').val();
        var username = $('#frmusername').val();
        var email = $('#frmemail').val();
        var currpass = $('#currpass').val();
        var newpass = $('#newpass').val();
        var newpassconfirm = $('#newpassconfirm').val();
        if( uppass==true && newpass === newpassconfirm ){
            passpram ={
              name : name,
              username : username,
              email : email,
              currpass : currpass,
              newpass : newpass,
              uppass : uppass
            }
            }else if(uppass==false){
              passpram ={
              name : name,
              username : username,
              email : email,
              uppass : uppass
            }
            }else{
                toastr.error('PASSWORDS MISMATCH')
            }
          $.ajax({
            type : 'POST',
            url:'/users/updateusersettings',
            headers: {"x-access-token": localStorage.getItem('token')},
            data : passpram,
            success : function(response){
              if(response.success ==1 && response.failure ==0) toastr.info(response.msg);
              if(response.success == 0 && response.failure == 1){
                  if(response.errorData == true){
                      $.each(response.errors, function(i, item) {
                      toastr.error(response.errors[i].msg);// alert(data[i].PageName);
                      });
                  }else{
                      toastr.error(response.msg);
                  }
              }
              localStorage.removeItem("loggedInName");
              localStorage.setItem("loggedInName", name);
              setTimeout(() => {
                location.reload();
              }, 3000);   
            },
            error : function(response){}
          });
        

      });

      // $('#btn_upload').submit(function(e){
      //     //e.preventDefault();
      //     //var title = $('#title').val(); 
      //     $(this).ajaxSubmit({
      //       //data: {title: title},
      //       //headers : { "x-access-token" : localStorage.getItem('token') },
      //       headers: {"x-access-token": localStorage.getItem('token')},
      //       contentType: 'application/json',
      //       success: function(response){
      //         toastr.info(response.msg);     
      //       }
      //   });
      //     return false;
      // });

  });
</script>